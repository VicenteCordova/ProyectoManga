{% extends 'base.html' %}
{% block title %}{{ view.object|default:'Nuevo Manga' }}{% endblock %}

{% block content %}
<div class="container mt-4">

  <style>
    /* Afinar inputs en tema oscuro */
    .mv-form.card.bg-dark .form-control,
    .mv-form.card.bg-dark .form-select{
      background-color:#12161d !important;
      color:#fff !important;
      border-color:#2a2f3a !important;
    }
    .mv-form .form-text{ color:#9aa4b2 !important; }
    .mv-form .form-check-input{ background-color:#12161d; border-color:#2a2f3a; }
    .mv-form .form-check-input:checked{ background:#0d6efd; border-color:#0d6efd; }
    .mv-subcard{ background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.06); }
    .mv-hr{ border-color:#2a2f3a; opacity:.6; }
    .mv-label{ color:#fff; }
  </style>

  <h1 class="h4 text-white mb-3">{{ view.object|default:'Nuevo Manga' }}</h1>

  <form method="post" enctype="multipart/form-data"
        class="mv-form card bg-dark text-white border-0 rounded-4 shadow-lg p-3 p-md-4">
    {% csrf_token %}

    {{ form.non_field_errors }}

    <!-- ORDEN EXPLÍCITO Y VERTICAL: Título, Autor, Descripción -->
    <div class="mb-4">
      <label class="form-label mv-label" for="{{ form.titulo.id_for_label }}">Título</label>
      {{ form.titulo }}
      {% for e in form.titulo.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>

    <div class="mb-4">
      <label class="form-label mv-label" for="{{ form.autor.id_for_label }}">Autor</label>
      {{ form.autor }}
      {% for e in form.autor.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>

    <div class="mb-3 display-flex">
      <label class="form-label mv-label" for="{{ form.descripcion.id_for_label }}">Descripción</label>
      {{ form.descripcion }}
      {% for e in form.descripcion.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>

    {# Campos opcionales extras si existen en el form #}
    {% if form.sinopsis %}
      <div class="mb-3">
        <label class="form-label mv-label" for="{{ form.sinopsis.id_for_label }}">Sinopsis</label>
        {{ form.sinopsis }}
        {% for e in form.sinopsis.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
    {% endif %}

    {% if form.portada %}
      <div class="mb-3">
        <label class="form-label mv-label" for="{{ form.portada.id_for_label }}">Portada</label>
        {{ form.portada }}
        {% for e in form.portada.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
      </div>
    {% endif %}

    <hr class="my-4 mv-hr">

    <!-- Capítulos  -->
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h2 class="h5 mb-0 text-white">Capítulos</h2>
      <button id="add-chapter" class="btn btn-outline-light btn-sm" type="button">+ Agregar capítulo</button>
    </div>

    {{ chapters_formset.management_form }}
    {{ chapters_formset.non_form_errors }}

    <div id="chapters-formset" class="row g-3">
      {% for f in chapters_formset.forms %}
        <div class="col-12 formset-form">
          <div class="card mv-subcard text-white rounded-4 p-3">
            <div class="row g-3">
              {% for field in f.visible_fields %}
                <div class="col-12 col-md-6 col-lg-4">
                  <label class="form-label mv-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                  {{ field }}
                </div>
              {% endfor %}
              {% if f.can_delete %}
                <div class="col-12 col-md-auto d-flex align-items-end">
                  <div class="form-check">
                    {{ f.DELETE }} <label class="form-check-label text-white-50">Eliminar</label>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Plantilla oculta para nuevas filas -->
    <div id="empty-form" class="d-none">
      <div class="col-12 formset-form">
        <div class="card mv-subcard text-white rounded-4 p-3">
          <div class="row g-3">
            {% for field in chapters_formset.empty_form.visible_fields %}
              <div class="col-12 col-md-6 col-lg-4">
                <label class="form-label mv-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field }}
              </div>
            {% endfor %}
            {% if chapters_formset.empty_form.can_delete %}
              <div class="col-12 col-md-auto d-flex align-items-end">
                <div class="form-check">
                  {{ chapters_formset.empty_form.DELETE }} <label class="form-check-label text-white-50">Eliminar</label>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="alert alert-info bg-opacity-10 border-info text-info mt-3">
      Puedes agregar múltiples capítulos con el botón “Agregar capítulo”.
    </div>

    <div class="d-flex gap-2 mt-3">
      <button class="btn btn-primary" type="submit">Guardar</button>
      <a class="btn btn-outline-light" href="{% url 'catalogo:lista-mangas' %}">Cancelar</a>
    </div>
  </form>
</div>

<!-- JS -->
<script>
(function() {
  const prefix = 'chapters';
  const totalInput = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
  const container = document.getElementById('chapters-formset');
  const addBtn = document.getElementById('add-chapter');
  const emptyDiv = document.getElementById('empty-form');
  if (!totalInput || !container || !addBtn || !emptyDiv) return;

  addBtn.addEventListener('click', function (e) {
    e.preventDefault();
    const index = parseInt(totalInput.value, 10) || 0;
    const wrapper = document.createElement('div');
    wrapper.innerHTML = emptyDiv.innerHTML.replace(/__prefix__/g, index).trim();
    container.appendChild(wrapper.firstElementChild);
    totalInput.value = index + 1;
  });
})();
</script>
{% endblock %}
