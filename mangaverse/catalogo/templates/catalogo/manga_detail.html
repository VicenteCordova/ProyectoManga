{% extends 'base.html' %}
{% load static %}

{% block title %}{{ manga.titulo }} | Detalle{% endblock %}

{% block content %}
<div class="position-absolute top-0 start-0 w-100 h-50 overflow-hidden" style="z-index: -1; mask-image: linear-gradient(to bottom, black, transparent);">
  {% if manga.portada %}
    <img src="{{ manga.portada.url }}" class="w-100 h-100 object-fit-cover opacity-25" style="filter: blur(40px);">
  {% endif %}
</div>

<div class="container py-5">
  <div class="row g-5">
    <div class="col-md-4 col-lg-3">
      <div class="position-relative shadow-lg rounded-3 overflow-hidden border border-white border-opacity-10">
        {% if manga.portada %}
          <img src="{{ manga.portada.url }}" class="w-100 d-block">
        {% else %}
          <div class="ratio ratio-3x4 bg-dark d-flex align-items-center justify-content-center">
            <img src="{% static 'images/sinfondo.png' %}" class="w-50 opacity-50">
          </div>
        {% endif %}
      </div>
      
      {% if perms.catalogo.change_manga %}
        <div class="d-grid gap-2 mt-3">
          <a href="{% url 'catalogo:manga-update' manga.slug %}" class="btn btn-sm btn-outline-secondary">Editar Manga</a>
        </div>
      {% endif %}
    </div>

    <div class="col-md-8 col-lg-9">
      <h1 class="display-4 fw-bold text-white mb-1 text-uppercase" style="font-family: 'Rajdhani', sans-serif;">{{ manga.titulo }}</h1>
      <p class="h5 text-secondary mb-4">Autor: <span class="text-white">{{ manga.autor }}</span></p>

      <div class="mb-4">
        {% if user.is_authenticated %}
          <button id="fav-btn" data-url="{% url 'accounts:add_favorite' manga.slug %}" class="btn btn-outline-light rounded-pill px-4 d-flex align-items-center gap-2">
            {% if manga in user.profile.favorites.all %}
              <span>‚ù§Ô∏è</span> <span>En Favoritos</span>
            {% else %}
              <span>ü§ç</span> <span>A√±adir a Favoritos</span>
            {% endif %}
          </button>
        {% endif %}
      </div>

      <div class="card bg-dark bg-opacity-50 border-0 rounded-4 p-4 mb-5">
        <h6 class="text-uppercase text-secondary fw-bold ls-1 mb-2">Sinopsis</h6>
        <p class="text-white-50 mb-0" style="line-height: 1.7;">
          {{ manga.descripcion|default:"Sin descripci√≥n."|linebreaks }}
        </p>
      </div>

      <div class="d-flex align-items-center justify-content-between mb-3 border-bottom border-white border-opacity-10 pb-2">
        <h3 class="h4 text-white mb-0">Cap√≠tulos</h3>
        <span class="badge bg-secondary bg-opacity-25 text-secondary">{{ chapters.count }}</span>
      </div>

      {% if chapters %}
        <div class="list-group rounded-3 overflow-hidden">
          {% for chapter in chapters %}
            <a href="{% url 'catalogo:chapter-detail' manga.slug chapter.slug %}" 
               class="list-group-item list-group-item-action bg-dark text-white border-secondary border-opacity-25 p-3 d-flex justify-content-between align-items-center">
              <div>
                <span class="fw-bold text-primary me-2">#{{ chapter.chapter_number }}</span>
                {{ chapter.title }}
              </div>
              <small class="text-secondary">Leer ‚ûî</small>
            </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-white-50">No hay cap√≠tulos a√∫n.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
  const favBtn = document.getElementById('fav-btn');
  if(favBtn){
    favBtn.addEventListener('click', function() {
      fetch(this.dataset.url, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
      })
      .then(res => res.json())
      .then(data => {
        this.innerHTML = data.liked ? '<span>‚ù§Ô∏è</span> <span>En Favoritos</span>' : '<span>ü§ç</span> <span>A√±adir a Favoritos</span>';
      });
    });
  }
</script>
{% endblock %}