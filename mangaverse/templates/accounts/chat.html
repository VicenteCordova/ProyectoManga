{% extends layout|default:"base.html" %}
{% load static %}

{% block title %}Chat con {{ other_user.username }}{% endblock %}

{% block content %}
<div class="{% if not request.GET.mini %}container py-5{% else %}container-fluid px-3 pt-3 h-100{% endif %} d-flex flex-column">

    <div class="{% if not request.GET.mini %}chat-card-full{% else %}h-100{% endif %} d-flex flex-column p-0">
        
        <div class="d-flex align-items-center justify-content-between mb-3 border-bottom border-white border-opacity-10 pb-2 flex-shrink-0 pt-2" 
             style="padding-bottom: 15px !important; padding-top: {% if not request.GET.mini %}20px{% else %}0{% endif %}; border-bottom-width: {% if not request.GET.mini %}0{% endif %} !important;">
            
            <div class="d-flex align-items-center gap-3">
                <a href="{% url 'accounts:inbox' %}{% if request.GET.mini %}?mini=true{% endif %}" 
                   class="btn btn-icon-only text-secondary hover-text-white ps-0" title="Volver">
                  <i class="bi bi-arrow-left fs-5"></i>
                </a>
                
                <div class="d-flex align-items-center gap-2">
                   <div class="position-relative">
                      {% if other_user.profile.avatar %}
                          <img src="{{ other_user.profile.avatar.url }}" class="rounded-circle border border-secondary" width="35" height="35" style="object-fit: cover;">
                      {% else %}
                          <img src="{% static 'images/sinfondo.png' %}" class="rounded-circle bg-dark p-1" width="35" height="35">
                      {% endif %}
                      <span class="position-absolute bottom-0 end-0 p-1 bg-success border border-dark rounded-circle" style="width: 10px; height: 10px;"></span>
                   </div>
                   <div>
                      <h6 class="mb-0 text-white fw-bold small">{{ other_user.username }}</h6>
                      <small class="text-success" style="font-size: 0.65rem;">‚óè En l√≠nea</small>
                   </div>
                </div>
            </div>

            <button type="button" class="btn btn-icon-only text-danger opacity-75 hover-opacity-100" data-bs-toggle="modal" data-bs-target="#deleteChatModal" title="Vaciar Chat">
              <i class="bi bi-trash3-fill"></i>
            </button>
        </div>

        <div class="flex-grow-1 overflow-y-auto p-2" id="chat-box" style="padding-bottom: 70px !important;">
          {% for msg in messages_list %}
            <div class="d-flex mb-2 {% if msg.sender == user %}justify-content-end{% else %}justify-content-start{% endif %} animate-fade-in">
              <div class="px-3 py-2 rounded-3 shadow-sm text-break" 
                   style="max-width: 85%; 
                          font-size: 0.9rem;
                          background-color: {% if msg.sender == user %}#7c4dff{% else %}#27272a{% endif %};
                          color: white;
                          border-bottom-{% if msg.sender == user %}right{% else %}left{% endif %}-radius: 2px;">
                {{ msg.content }}
                <div class="text-end opacity-50 mt-1" style="font-size: 0.6rem; line-height: 1;">
                  {{ msg.timestamp|date:"H:i" }}
                  {% if msg.sender == user %}<i class="bi bi-check2 ms-1"></i>{% endif %}
                </div>
              </div>
            </div>
          {% empty %}
            <div class="text-center text-secondary mt-5">
              <small>Comienza la charla con {{ other_user.username }} üëã</small>
            </div>
          {% endfor %}
        </div>

        <form id="chat-form" method="post" class="d-flex gap-2 flex-shrink-0 py-3 mt-auto border-top border-secondary border-opacity-25" 
              style="padding-bottom: 0 !important; background: {% if not request.GET.mini %}#121212{% else %}transparent{% endif %};">
          {% csrf_token %}
          <input type="text" name="content" id="msg-input" 
                 class="form-control flex-grow-1 bg-dark text-white border-secondary rounded-pill shadow-none" 
                 placeholder="Escribe aqu√≠..." autocomplete="off" required style="font-size: 0.9rem;">
          <button type="submit" class="btn btn-brand-neon rounded-circle d-flex align-items-center justify-content-center shadow-neon" 
                  style="width: 40px; height: 40px;">
            <i class="bi bi-send-fill small"></i>
          </button>
        </form>

    </div>
    
  </div>

<div class="modal fade" id="deleteChatModal" tabindex="-1" aria-hidden="true" style="z-index: 10000;">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content bg-dark border-secondary shadow-lg">
      <div class="modal-body text-center p-4">
        <div class="mb-3 text-danger display-6"><i class="bi bi-exclamation-triangle-fill"></i></div>
        <h6 class="text-white fw-bold mb-2">¬øBorrar historial?</h6>
        <p class="text-white-50 small mb-4">Se eliminar√°n todos los mensajes con este usuario.</p>
        
        <div class="d-flex gap-2 justify-content-center">
          <button type="button" class="btn btn-sm btn-outline-secondary text-white" data-bs-dismiss="modal">Cancelar</button>
          
          <form action="{% url 'accounts:delete_chat' other_user.username %}{% if request.GET.mini %}?mini=true{% endif %}" method="post">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger fw-bold px-3">Borrar</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const chatBox = document.getElementById('chat-box');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('msg-input');

    // Auto-scroll al fondo
    function scrollToBottom() { chatBox.scrollTop = chatBox.scrollHeight; }
    scrollToBottom();

    // Enviar mensaje con AJAX
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const content = input.value.trim();
      if(!content) return;

      const formData = new FormData(form);
      
      // Feedback inmediato
      const tempId = Date.now();
      const tempHtml = `
        <div class="d-flex mb-2 justify-content-end animate-fade-in" id="msg-${tempId}">
          <div class="px-3 py-2 rounded-3 shadow-sm text-break" style="max-width: 85%; font-size: 0.9rem; background-color: #7c4dff; color: white; border-bottom-right-radius: 2px; opacity: 0.7;">
            ${content}
            <div class="text-end opacity-50 mt-1" style="font-size: 0.6rem; line-height: 1;">Enviando...</div>
          </div>
        </div>`;
      chatBox.insertAdjacentHTML('beforeend', tempHtml);
      scrollToBottom();
      input.value = '';

      // Petici√≥n al servidor
      fetch(window.location.href, {
        method: 'POST', 
        body: formData, 
        headers: {'X-Requested-With': 'XMLHttpRequest'}
      })
      .then(response => response.json())
      .then(data => {
        if(data.status === 'ok') {
            // Reemplazar temporal por final
            const tempMsg = document.getElementById(`msg-${tempId}`);
            if(tempMsg) tempMsg.remove(); 

            const finalHtml = `
            <div class="d-flex mb-2 justify-content-end animate-fade-in">
              <div class="px-3 py-2 rounded-3 shadow-sm text-break" style="max-width: 85%; font-size: 0.9rem; background-color: #7c4dff; color: white; border-bottom-right-radius: 2px;">
                ${data.content}
                <div class="text-end opacity-50 mt-1" style="font-size: 0.6rem; line-height: 1;">
                  ${data.timestamp} <i class="bi bi-check2"></i>
                </div>
              </div>
            </div>`;
            chatBox.insertAdjacentHTML('beforeend', finalHtml);
            scrollToBottom();
        }
      });
    });
  });
</script>

<style>
  /* Scrollbar fina */
  #chat-box::-webkit-scrollbar { width: 5px; }
  #chat-box::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
  #chat-box::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
  #chat-box::-webkit-scrollbar-thumb:hover { background: #666; }

  .animate-fade-in { animation: fadeIn 0.2s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { transform: translateY(0); } }

  /* Estilo Espec√≠fico para el modo Full Page */
  .chat-card-full {
      width: 100%;
      min-height: 80vh;
      margin: 0 auto;
      max-width: 800px;
      border-radius: 16px;
      padding: 0 !important;
  }
</style>
{% endblock %}