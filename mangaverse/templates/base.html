{% load static %}
<!doctype html>
<html lang="es" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}MangaVerse{% endblock %}</title>
  <link rel="icon" type="image/png" href="{% static 'images/sinfondo.png' %}">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <link rel="stylesheet" href="{% static 'css/site.css' %}">

  {% block extra_head %}{% endblock %}
</head>
<body>

  <div class="bg-layer">
    <iframe class="bg-iframe" src="{% static 'fondo.html' %}" title="Fondo" loading="lazy"></iframe>
  </div>
  <div class="bg-overlay"></div>

  <div class="page-wrap">
    
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" style="background: rgba(9,9,11,0.85); backdrop-filter: blur(12px); border-bottom: 1px solid var(--mv-border);">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center gap-2" href="{% url 'catalogo:home' %}">
          <img src="{% static 'images/sinfondo.png' %}" width="32" height="32" alt="Logo">
          <span style="font-family: 'Rajdhani', sans-serif; font-weight: 700; letter-spacing: 1px;">MANGAVERSE</span>
        </a>

        <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#mvNav">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mvNav">
          <ul class="navbar-nav me-auto ms-3 gap-3">
            <li class="nav-item"><a class="nav-link fw-medium text-uppercase fs-7" href="{% url 'catalogo:lista-mangas' %}">Cat√°logo</a></li>
            <li class="nav-item"><a class="nav-link fw-medium text-uppercase fs-7" href="{% url 'catalogo:nosotros' %}">Misi√≥n</a></li>
          </ul>

          <form class="d-none d-lg-flex position-relative me-3" role="search" 
                method="get" action="{% url 'catalogo:search' %}" 
                id="navbar-search-form" autocomplete="off">
            
            <div class="input-group input-group-sm">
              <input type="search" 
                     name="q" 
                     id="navbar-search-input" 
                     class="form-control bg-dark border-secondary text-white" 
                     placeholder="Buscar manga..." 
                     aria-label="Buscar" 
                     value="{{ request.GET.q|default:'' }}"
                     autocomplete="off">
              <button class="btn btn-outline-secondary" type="submit">üîç</button>
            </div>

            <div id="live-results" 
                 class="list-group position-absolute w-100 shadow-lg mt-1 overflow-hidden" 
                 style="top: 100%; left: 0; z-index: 1050; display: none; border: 1px solid rgba(255,255,255,0.15); border-radius: 0.5rem;">
            </div>
          </form>

          <ul class="navbar-nav gap-2 align-items-center">
            {% if user.is_authenticated %}
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" data-bs-toggle="dropdown">
                  {% if user.profile.avatar %}
                    <img src="{{ user.profile.avatar.url }}" class="rounded-circle border border-secondary" width="30" height="30" style="object-fit:cover;">
                  {% else %}
                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center border border-dark" style="width:30px; height:30px;">
                      {{ user.username|slice:":1"|upper }}
                    </div>
                  {% endif %}
                  <span class="small fw-bold font-monospace">{{ user.username }}</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end bg-dark border-secondary shadow-lg mt-2">
                  <li><a class="dropdown-item text-white-50" href="{% url 'accounts:profile' %}">üë§ Mi Perfil</a></li>
                  <li><hr class="dropdown-divider bg-secondary opacity-25"></li>
                  <li>
                    <form action="{% url 'accounts:logout' %}" method="post" class="d-inline w-100">
                      {% csrf_token %}
                      <button type="submit" class="dropdown-item text-danger w-100 text-start">üö™ Cerrar Sesi√≥n</button>
                    </form>
                  </li>
                </ul>
              </li>
            {% else %}
              <li class="nav-item"><a href="{% url 'accounts:login' %}" class="btn btn-sm btn-outline-light rounded-pill px-3 fw-bold">Ingresar</a></li>
              <li class="nav-item"><a href="{% url 'accounts:register' %}" class="btn btn-sm btn-brand-neon rounded-pill px-3 text-dark fw-bold">Registro</a></li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <main class="flex-fill position-relative" style="margin-top: 80px;">
      {% if messages %}
        <div class="container position-absolute top-0 start-50 translate-middle-x mt-3" style="z-index: 1100; pointer-events: none;">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-lg border-0 text-white" role="alert" 
                 style="pointer-events: auto; backdrop-filter: blur(10px); background-color: {% if message.tags == 'success' %}rgba(25, 135, 84, 0.9){% else %}rgba(220, 53, 69, 0.9){% endif %};">
              {{ message }}
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% block content %}{% endblock %}
    </main>

    <footer class="border-top border-white border-opacity-10 py-4 mt-auto bg-black text-center text-white-50 small">
      <div class="container">
        <p class="mb-0">¬© 2025 MangaVerse. Hecho por fans para fans.</p>
      </div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (function(){
    "use strict";

    const input = document.getElementById('navbar-search-input');
    const resultsBox = document.getElementById('live-results');
    const form = document.getElementById('navbar-search-form');
    let timeout = null;

    function hideResults() {
      resultsBox.style.display = 'none';
      resultsBox.innerHTML = '';
    }

    if(input){
      input.addEventListener('input', function() {
        const query = this.value.trim();
        clearTimeout(timeout);

        if (query.length < 2) {
          hideResults();
          return;
        }

        // Debounce de 300ms
        timeout = setTimeout(() => {
          resultsBox.style.display = 'block';
          resultsBox.innerHTML = `
            <div class="list-group-item bg-dark text-secondary border-0 p-3">
              <span class="spinner-border spinner-border-sm me-2"></span> Buscando...
            </div>`;

          fetch(`{% url 'catalogo:search-suggest' %}?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
              resultsBox.innerHTML = '';
              if (!data.results || data.results.length === 0) {
                resultsBox.innerHTML = `
                  <div class="list-group-item bg-dark text-white-50 border-0 p-3 small">
                    No se encontraron resultados.
                  </div>`;
              } else {
                data.results.forEach(item => {
                  const a = document.createElement('a');
                  a.href = item.url;
                  a.className = 'list-group-item list-group-item-action bg-dark text-white border-bottom border-secondary border-opacity-25 d-flex align-items-center p-2';
                  
                  // Miniatura o Placeholder
                  let imgHTML = '';
                  if(item.cover){
                    imgHTML = `<img src="${item.cover}" class="rounded me-3" width="40" height="55" style="object-fit: cover;">`;
                  } else {
                    imgHTML = `<div class="rounded me-3 bg-secondary d-flex align-items-center justify-content-center" style="width:40px; height:55px;"><small class="text-white-50" style="font-size:0.6rem">IMG</small></div>`;
                  }

                  a.innerHTML = `
                    ${imgHTML}
                    <div>
                      <div class="fw-bold small text-truncate" style="max-width: 180px;">${item.title}</div>
                      <div class="text-white-50" style="font-size: 0.75rem;">${item.author || 'Autor desconocido'}</div>
                    </div>
                  `;
                  resultsBox.appendChild(a);
                });
              }
            })
            .catch(err => {
              console.error("Search error:", err);
              hideResults();
            });
        }, 300);
      });

      // Ocultar al hacer clic fuera
      document.addEventListener('click', function(e) {
        if (!form.contains(e.target)) hideResults();
      });
      
      // Ocultar con Escape
      input.addEventListener('keydown', function(e){
        if(e.key === 'Escape') hideResults();
      });
    }
  })();
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>